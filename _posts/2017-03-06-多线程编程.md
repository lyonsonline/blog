---
layout: post
title: "GCD"
date: 2017-03-06
excerpt: "ç®€å•è®°å½•GCDç›¸å…³çŸ¥è¯†"
tags: [IOS, Swift, GCD]
feature: http://i.imgur.com/Ds6S7lJ.png
comments: true
---
# GCD(Grand Central Dispatch)

> æ ¸å¿ƒæ˜¯dispatch queue,é˜Ÿåˆ—å°±æ˜¯ä¸€ç³»åˆ—çš„ä»£ç å—(WorkItemä»»åŠ¡é¡¹).ä¸€èˆ¬è€—æ—¶å’Œéœ€è¦CPUå¤§é‡è®¡ç®—çš„æ—¶å€™è¦åˆ†åœ¨åå°çº¿ç¨‹,**æ›´æ–°UIæ“ä½œè¦æ”¾åœ¨ä¸»çº¿ç¨‹**.

- åˆ›å»ºdispatch queue

  ```swift
  let queue = DispatchQueue(label: "com.eric.myqueue")
  ```

  > æœ€å¥½ä¸ºé˜Ÿåˆ—åˆ›å»ºlabel.åå‘DNS`com.eric.myqueue`

- ä½¿ç”¨`sync`åŒæ­¥,`async`å¼‚æ­¥æ‰§è¡Œ

  ```swift
  //åŒæ­¥æ‰§è¡Œ
  queue.sync {
    for i in 0..<10 {
      print("ğŸ”´", i)
    }
  }
  //å¼‚æ­¥æ‰§è¡Œ
  queue.async {
    for i in 0..<10 {
      print("ğŸ”´", i)
    }
  }
  ```

## Quality Of Service(QoS) å’Œä¼˜å…ˆçº§

> ç”±äºä¸»é˜Ÿåˆ—æ€»æ˜¯ç”¨æ¥å¤„ç† UI ä»¥åŠç•Œé¢çš„å“åº”ï¼Œæ‰€ä»¥åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡æ°¸è¿œéƒ½æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§
>
> ç”¨äºæŒ‡å®šä»»åŠ¡é‡è¦ç¨‹åº¦ä»¥åŠä¼˜å…ˆçº§çš„ä¿¡æ¯ï¼Œåœ¨ GCD ä¸­è¢«ç§°ä¸º Quality of Serviceï¼ˆQoSï¼‰
>
> *ä¼˜å…ˆçº§ä»å¤§åˆ°å°*
>
> 1. `userInteractive`
> 2. `userInitiated`
> 3. `default`
> 4. `utility`
> 5. `background`
> 6. `unspecified`

**ä¸»é˜Ÿåˆ—æ‰§è¡Œçš„ä»»åŠ¡æœ‰æœ€é«˜ä¼˜å…ˆçº§**

ä¼˜å…ˆçº§é˜Ÿåˆ—åˆå§‹åŒ–æ–¹æ³•:

```swift
let queue = DispatchQueue(label: "com.appcoda.queue1", qos: DispatchQoS.userInitiated)
```

## å¹¶è¡Œé˜Ÿåˆ—

ä½¿ç”¨`attributes`å±æ€§è®¾ç½®`concurrent`å¹¶å‘é˜Ÿåˆ—

```swift
let anotherQueue = DispatchQueue(label: "com.appcoda.anotherQueue", qos: .utility, attributes: .concurrent)
inactiveQueue = anotherQueue
```

> è¿™ä¸ª `attributes` å‚æ•°ä¹Ÿå¯ä»¥æ¥å—å¦ä¸€ä¸ªåä¸º `initiallyInactive` çš„å€¼ã€‚å¦‚æœä½¿ç”¨è¿™ä¸ªå€¼ï¼Œä»»åŠ¡ä¸ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼Œè€Œæ˜¯éœ€è¦å¼€å‘è€…æ‰‹åŠ¨å»è§¦å‘ã€‚
>
> `DispatchQueue` ç±»çš„ `activate()` æ–¹æ³•ä¼šè®©ä»»åŠ¡å¼€å§‹æ‰§è¡Œã€‚æ³¨æ„ï¼Œè¿™ä¸ªé˜Ÿåˆ—å¹¶æ²¡æœ‰è¢«æŒ‡å®šä¸ºå¹¶è¡Œé˜Ÿåˆ—ï¼Œå› æ­¤å®ƒä»¬ä¼šä»¥ä¸²è¡Œçš„æ–¹å¼æ‰§è¡Œ

```swift
//æ‰‹åŠ¨è§¦å‘
if let queue = inactiveQueue {
    queue.activate()
}
```

ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•åœ¨æŒ‡å®š `initiallyInactive` çš„åŒæ—¶å°†é˜Ÿåˆ—æŒ‡å®šä¸ºå¹¶è¡Œé˜Ÿåˆ—ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸¤ä¸ªå€¼æ”¾å…¥ä¸€ä¸ªæ•°ç»„å½“ä¸­ï¼Œä½œä¸º `attributes` çš„å‚æ•°ï¼Œæ›¿ä»£åŸæœ¬æŒ‡å®šçš„å•ä¸€æ•°å€¼ï¼š

```swift
let anotherQueue = DispatchQueue(label: "com.appcoda.anotherQueue", qos: .userInitiated, attributes: [.concurrent, .initiallyInactive])
```

## å»¶è¿Ÿæ‰§è¡Œ

```swift
let delayQueue = DispatchQueue(label: "com.appcoda.delayqueue", qos: .userInitiated)

print(Date())

let additionalTime: DispatchTimeInterval = .seconds(2)
```

> ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬åƒé€šå¸¸ä¸€æ ·åˆ›å»ºäº†ä¸€ä¸ª `DispatchQueue`ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¼šåœ¨ä¸‹ä¸€æ­¥ä¸­è¢«ä½¿ç”¨åˆ°ã€‚æ¥ç€ï¼Œæˆ‘ä»¬æ‰“å°äº†å½“å‰æ—¶é—´ï¼Œä¹‹åè¿™ä¸ªæ—¶é—´å°†ä¼šè¢«ç”¨æ¥éªŒè¯æ‰§è¡Œä»»åŠ¡çš„å»¶è¿Ÿæ—¶é—´ï¼Œæœ€åæˆ‘ä»¬æŒ‡å®šäº†å»¶è¿Ÿæ—¶é—´ã€‚å»¶è¿Ÿæ—¶é—´é€šå¸¸æ˜¯ä¸€ä¸ª `DispatchTimeInterval` ç±»å‹çš„æšä¸¾å€¼ï¼ˆåœ¨å†…éƒ¨å®ƒè¢«è¡¨ç¤ºä¸ºæ•´å‹å€¼ï¼‰ï¼Œè¿™ä¸ªå€¼ä¼šè¢«æ·»åŠ åˆ° `DispatchTime` ä¸­ç”¨äºæŒ‡å®šå»¶è¿Ÿæ—¶é—´ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œè®¾å®šçš„ç­‰å¾…æ‰§è¡Œæ—¶é—´æ˜¯ä¸¤ç§’ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯` seconds `æ–¹æ³•ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼š
>
> - `microseconds`
> - `milliseconds`
> - `nanoseconds`

```swift
delayQueue.asyncAfter(deadline: .now() + additionalTime) {
    print(Date())
}
```

> é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰åˆ«çš„æ–¹æ³•å¯ä»¥ç”¨æ¥æŒ‡å®šæ‰§è¡Œæ—¶é—´ã€‚å¦‚æœä¸æƒ³ä½¿ç”¨ä»»åŠ¡é¢„å®šä¹‰çš„æ–¹æ³•ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ª Double ç±»å‹çš„å€¼æ·»åŠ åˆ°å½“å‰æ—¶é—´ä¸Šï¼š

```swift
delayQueue.asyncAfter(deadline: .now() + 0.75) {
    print(Date())
}
```

> Tips:
>
> æŒ‡å®šä¸€ä¸ª TimeIntervalï¼Œä¹Ÿå°±æ˜¯ä»¥ç§’ä¸ºå•ä½çš„æ•´æ•°æˆ–è€…åˆ†æ•°å½¢å¼
>
> ```swift
> extension DispatchTime: ExpressibleByIntegerLiteral {
>     public init(integerLiteral value: Int) {
>         self = DispatchTime.now() + .seconds(value)
>     }
> }
>
> extension DispatchTime: ExpressibleByFloatLiteral {
>     public init(floatLiteral value: Double) {
>         self = DispatchTime.now() + .milliseconds(Int(value * 1000))
>     }
> }
> ```
>
> ```swift
> DispatchQueue.main.asyncAfter(deadline: 5) { /* ... */ }
> ```
>
>

## è®¿é—®ä¸»é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—

> æ“ä½œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªåå°é˜Ÿåˆ—çš„é›†åˆï¼Œä¹Ÿè¢«ç§°ä¸ºå…¨å±€é˜Ÿåˆ—ï¼ˆglobal queueï¼‰

```swift
let globalQueue = DispatchQueue.global()
```

> å½“ä½¿ç”¨å…¨å±€é˜Ÿåˆ—çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰å¤ªå¤šçš„å±æ€§å¯ä¾›æˆ‘ä»¬è¿›è¡Œä¿®æ”¹ã€‚ä½†æ˜¯ï¼Œä½ ä»ç„¶å¯ä»¥æŒ‡å®šä½ æƒ³è¦ä½¿ç”¨é˜Ÿåˆ—çš„ Quality of Serviceï¼š

```swift
let globalQueue = DispatchQueue.global(qos: .userInitiated)
```

> ä¸»é˜Ÿåˆ—,é€šå¸¸ç”¨äºæ›´æ–°UI

```swift
DispatchQueue.main.async {
    // Do something
}
```

## ä½¿ç”¨DispatchWorkItem å¯¹è±¡

> DispatchWorkItem æ˜¯ä¸€ä¸ªä»£ç å—ï¼Œå®ƒå¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªé˜Ÿåˆ—ä¸Šè¢«è°ƒç”¨ï¼Œå› æ­¤å®ƒé‡Œé¢çš„ä»£ç å¯ä»¥åœ¨åå°è¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸»çº¿ç¨‹è¿è¡Œã€‚å®ƒçš„ä½¿ç”¨çœŸçš„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€å †å¯ä»¥ç›´æ¥è°ƒç”¨çš„ä»£ç ï¼Œè€Œä¸ç”¨åƒä¹‹å‰ä¸€æ ·æ¯æ¬¡éƒ½å†™ä¸€ä¸ªä»£ç å—

```swift
let workItem = DispatchWorkItem {
    // Do something
}
```

> æ‰§è¡Œ

```swift
workItem.perform()
```

> ä¸Šè¡Œä»£ç åœ¨ä¸»çº¿ç¨‹è°ƒç”¨,ä¹Ÿå¯ä»¥ç”¨å…¶å®ƒé˜Ÿåˆ—æ‰§è¡Œ

```swift
let queue = DispatchQueue.global()
queue.async {
    workItem.perform()
}
```

> å¿«æ·æ‰§è¡Œ

```swift
queue.async(execute: workItem)
```

> å½“ä¸€ä¸ªä»»åŠ¡é¡¹è¢«è°ƒç”¨åï¼Œä½ å¯ä»¥é€šçŸ¥ä¸»é˜Ÿåˆ—ï¼ˆæˆ–è€…ä»»ä½•å…¶å®ƒä½ æƒ³è¦çš„é˜Ÿåˆ—ï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```swift
workItem.notify(queue: DispatchQueue.main) {
    print("value = ", value)
}
```

## æ³¨æ„ç‚¹

1. ```swift
   print("1")
   DispatchQueue.main.sync {
       print("2")
   }
   print("3")
   ```

   > ä¼šä¸­æ–­çº¿ç¨‹,Error

2. ```swift
   print("1")
   DispatchQueue.main.async {
       print("2")
   }
   print("3")
   ```

   > æ‰§è¡Œé¡ºåº1->3->2
